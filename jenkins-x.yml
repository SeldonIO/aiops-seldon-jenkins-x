buildPack: none
pipelineConfig:
  pipelines:
    release:
      pipeline:
        agent:
          image: seldonio/core-builder:0.4
        stages:
        - name: test-and-deploy-sklearn-server
          steps:
          - name: run-tests
            command: make
            args:
            - install_dev
            - test
        - dir: ./charts/preview
          steps:
          - sh: make preview
            name: make-preview
          - sh: jx preview --app $APP_NAME --dir ../..
            name: jx-preview
        options:
          containerOptions:
            volumeMounts:
              - mountPath: /lib/modules
                name: modules
                readOnly: true
              - mountPath: /sys/fs/cgroup
                name: cgroup
              - name: dind-storage
                mountPath: /var/lib/docker
              - mountPath: /builder/home/.docker
                name: jenkins-docker-config-volume
            securityContext:
              privileged: true
          volumes:
            - name: modules
              hostPath:
                path: /lib/modules
                type: Directory
            - name: cgroup
              hostPath:
                path: /sys/fs/cgroup
                type: Directory
            - name: dind-storage
              emptyDir: {}
            - name: jenkins-docker-config-volume
              secret:
                items:
                - key: config.json
                  path: config.json
                secretName: jenkins-docker-cfg
    pullRequest:
      pipeline:
        agent:
          image: seldonio/core-builder:0.4
        stages:
        - name: build-and-test
          parallel:
          - name: test-and-deploy-sklearn-server
            steps:
            - name: run-tests
              command: make
              args:
              - install_dev
              - test
        - dir: ./charts/REPLACE_ME_APP_NAME
          steps:
          - sh: jx step changelog --batch-mode --version v\$(cat ../../VERSION)
            name: changelog
          - comment: release the helm chart
            sh: jx step helm release
            name: helm-release
          - comment: promote through all 'Auto' promotion Environments
            sh: jx promote -b --all-auto --timeout 1h --version \$(cat ../../VERSION)
            name: jx-promote
        options:
          containerOptions:
            volumeMounts:
              - mountPath: /lib/modules
                name: modules
                readOnly: true
              - mountPath: /sys/fs/cgroup
                name: cgroup
              - name: dind-storage
                mountPath: /var/lib/docker
              - mountPath: /builder/home/.docker
                name: jenkins-docker-config-volume
            securityContext:
              privileged: true
          volumes:
            - name: modules
              hostPath:
                path: /lib/modules
                type: Directory
            - name: cgroup
              hostPath:
                path: /sys/fs/cgroup
                type: Directory
            - name: dind-storage
              emptyDir: {}
            - name: jenkins-docker-config-volume
              secret:
                items:
                - key: config.json
                  path: config.json
                secretName: jenkins-docker-cfg
