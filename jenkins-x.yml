buildPack: none
pipelineConfig:
  pipelines:
    release:
      pipeline:
        agent:
          image: seldonio/core-builder:0.4
        stages:
        - name: test-and-deploy-sklearn-server
          steps:
          - name: run-tests
            command: make
            args:
            - install_dev
            - test
        - name: promote
          steps:
          - name: make-preview
            sh: cd charts/preview && make preview
          - name: jx-preview
            sh: cd charts/preview && jx preview --app $APP_NAME --dir ../..
        options:
          containerOptions:
            volumeMounts:
              - mountPath: /lib/modules
                name: modules
                readOnly: true
              - mountPath: /sys/fs/cgroup
                name: cgroup
              - name: dind-storage
                mountPath: /var/lib/docker
              - mountPath: /builder/home/.docker
                name: jenkins-docker-config-volume
            securityContext:
              privileged: true
          volumes:
            - name: modules
              hostPath:
                path: /lib/modules
                type: Directory
            - name: cgroup
              hostPath:
                path: /sys/fs/cgroup
                type: Directory
            - name: dind-storage
              emptyDir: {}
            - name: jenkins-docker-config-volume
              secret:
                items:
                - key: config.json
                  path: config.json
                secretName: jenkins-docker-cfg
    pullRequest:
      pipeline:
        agent:
          image: seldonio/core-builder:0.4
        stages:
        - name: test-and-deploy-sklearn-server
          steps:
          - name: run-tests
            command: make
            args:
            - install_dev
            - test
        - name: promote
          steps:
          - name: changelog
            sh: cd charts/sklearn-model-server && jx step changelog --batch-mode --version v\$(cat ../../VERSION)
          - name: helm-release
            sh: cd charts/sklearn-model-server && jx step helm release
          - name: helm-release
            sh: cd charts/sklearn-model-server && jx promote -b --all-auto --timeout 1h --version \$(cat ../../VERSION)
        options:
          containerOptions:
            volumeMounts:
              - mountPath: /lib/modules
                name: modules
                readOnly: true
              - mountPath: /sys/fs/cgroup
                name: cgroup
              - name: dind-storage
                mountPath: /var/lib/docker
              - mountPath: /builder/home/.docker
                name: jenkins-docker-config-volume
            securityContext:
              privileged: true
          volumes:
            - name: modules
              hostPath:
                path: /lib/modules
                type: Directory
            - name: cgroup
              hostPath:
                path: /sys/fs/cgroup
                type: Directory
            - name: dind-storage
              emptyDir: {}
            - name: jenkins-docker-config-volume
              secret:
                items:
                - key: config.json
                  path: config.json
                secretName: jenkins-docker-cfg
